<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>概念マップビューア</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2563eb;
      --secondary-color: #64748b;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --bg-color: #ffffff;
      --surface-color: #f8fafc;
      --border-color: #e2e8f0;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    
    html, body { 
      margin: 0; 
      height: 100%; 
      font-family: 'Noto Sans JP', system-ui, -apple-system, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-primary);
      font-size: 14px;
      line-height: 1.5;
    }
    
    #app { display: flex; height: 100vh; }
    
    #sidebar {
      width: 320px;
      background: var(--surface-color);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    #toolbar {
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-color);
    }
    
    #toolbar h1 {
      margin: 0 0 12px 0;
      font-size: 18px;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .filter-group {
      display: flex;
      gap: 12px;
      margin-bottom: 8px;
    }
    
    .filter-group label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      cursor: pointer;
    }
    
    input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--primary-color);
    }
    
    #details {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .concept-card {
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
    }
    
    .concept-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .concept-tier {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
    }
    
    .tier-core { background: var(--primary-color); color: white; }
    .tier-supplementary { background: var(--success-color); color: white; }
    .tier-advanced { background: var(--warning-color); color: white; }
    
    .concept-title {
      font-weight: 700;
      font-size: 15px;
      margin: 0;
      flex: 1;
    }
    
    .concept-definition {
      color: var(--text-secondary);
      font-size: 13px;
      margin-bottom: 12px;
      line-height: 1.4;
    }
    
    .evidence-section, .aliases-section {
      margin-top: 12px;
    }
    
    .section-title {
      font-weight: 600;
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }
    
    .evidence-item {
      background: #f1f5f9;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      line-height: 1.4;
      margin-bottom: 4px;
      border-left: 3px solid var(--primary-color);
    }
    
    .aliases {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    
    .alias-tag {
      background: #e2e8f0;
      color: var(--text-secondary);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
    }
    
    #graph-container {
      flex: 1;
      position: relative;
      overflow: hidden;
    }
    
    #graph {
      width: 100%;
      height: 100%;
    }
    
    .node { cursor: move; }
    .node circle { 
      stroke: #333; 
      stroke-width: 2px; 
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
    }
    .node.core circle { 
      fill: var(--primary-color); 
      stroke: #1d4ed8; 
    }
    .node.supplementary circle { 
      fill: var(--success-color); 
      stroke: #059669; 
    }
    .node.advanced circle { 
      fill: var(--warning-color); 
      stroke: #d97706; 
    }
    .node text { 
      font-size: 12px; 
      pointer-events: none; 
      font-weight: 500;
      fill: var(--text-primary);
    }
    .node.selected circle {
      stroke-width: 4px;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
    }
    
    .link { 
      stroke: var(--text-secondary); 
      stroke-opacity: 0.6; 
      stroke-width: 2px;
      marker-end: url(#arrowhead);
    }
    .link.selected { 
      stroke: var(--primary-color); 
      stroke-opacity: 0.8; 
      stroke-width: 3px;
    }
    
    .edge-label {
      font-size: 10px;
      fill: var(--text-secondary);
      text-anchor: middle;
      pointer-events: none;
      background: var(--bg-color);
      padding: 2px 4px;
      border-radius: 3px;
    }
    
    .tooltip { 
      position: absolute; 
      background: var(--bg-color); 
      border: 1px solid var(--border-color); 
      padding: 12px; 
      font-size: 13px; 
      border-radius: 8px; 
      box-shadow: var(--shadow-lg);
      max-width: 300px;
      z-index: 1000;
      pointer-events: none;
    }
    
    .zoom-controls {
      position: absolute;
      top: 16px;
      right: 16px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .zoom-btn {
      width: 36px;
      height: 36px;
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: var(--shadow);
      font-weight: 700;
      font-size: 18px;
      color: var(--text-primary);
      transition: all 0.2s;
    }
    
    .zoom-btn:hover {
      background: var(--surface-color);
      transform: translateY(-1px);
    }
    
    @media (max-width: 768px) {
      #sidebar {
        width: 100%;
        height: auto;
      }
      #graph-container {
        display: none;
      }
    }
    
    .relation-legend {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 12px;
    }
    
    .legend-line {
      width: 24px;
      height: 2px;
      background: var(--text-secondary);
    }
  </style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <div id="toolbar">
      <h1>概念マップ</h1>
      <div class="filter-group">
        <label><input type="checkbox" id="showCore" checked/> コア概念</label>
        <label><input type="checkbox" id="showSupplementary" checked/> 補助概念</label>
        <label><input type="checkbox" id="showAdvanced" checked/> 発展概念</label>
      </div>
      <div class="relation-legend">
        <div class="section-title">関係性の種類</div>
        <div class="legend-item">
          <div class="legend-line"></div>
          <span>part_of: の一部</span>
        </div>
        <div class="legend-item">
          <div class="legend-line"></div>
          <span>uses: を使用</span>
        </div>
        <div class="legend-item">
          <div class="legend-line"></div>
          <span>example_of: の例</span>
        </div>
      </div>
    </div>
    <div id="details">
      <div class="section-title">概念を選択してください</div>
      <p style="color: var(--text-secondary); font-size: 13px;">
        グラフ内のノードをクリックすると、詳細情報と証拠が表示されます。
      </p>
    </div>
  </div>
  
  <div id="graph-container">
    <div id="graph"></div>
    <div class="zoom-controls">
      <div class="zoom-btn" id="zoom-in">+</div>
      <div class="zoom-btn" id="zoom-out">−</div>
      <div class="zoom-btn" id="zoom-reset" style="font-size: 12px;">⌂</div>
    </div>
  </div>
</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
const data = /*__GRAPH_JSON__*/

// Graph setup
const container = d3.select("#graph");
const containerRect = container.node().getBoundingClientRect();
const width = containerRect.width;
const height = containerRect.height;

const svg = container.append("svg").attr("width", width).attr("height", height);
const g = svg.append("g");

// Arrow marker
svg.append("defs").append("marker")
  .attr("id", "arrowhead")
  .attr("viewBox", "0 -5 10 10")
  .attr("refX", 20)
  .attr("refY", 0)
  .attr("markerWidth", 6)
  .attr("markerHeight", 6)
  .attr("orient", "auto")
  .append("path")
  .attr("d", "M0,-5L10,0L0,5")
  .attr("fill", "#64748b");

const linkG = g.append("g");
const labelG = g.append("g");
const nodeG = g.append("g");

// Data processing
const id2node = new Map(data.nodes.map(d => [d.id, d]));
const links = data.edges.map(e => Object.assign({}, e, {
  source: id2node.get(e.source), 
  target: id2node.get(e.target)
}));

// Create elements
const link = linkG.selectAll("line").data(links).enter().append("line").attr("class", "link");

const edgeLabel = labelG.selectAll("text").data(links).enter().append("text")
  .attr("class", "edge-label")
  .text(d => d.type);

const node = nodeG.selectAll("g").data(data.nodes).enter().append("g")
  .attr("class", d => `node ${d.tier}`);

node.append("circle")
  .attr("r", d => d.tier === "core" ? 12 : (d.tier === "supplementary" ? 10 : 8));

node.append("text")
  .attr("dx", 16)
  .attr("dy", 4)
  .text(d => d.label);

// Tooltip
const tooltip = d3.select("body").append("div").attr("class", "tooltip").style("display", "none");

// Detail panel
const detailPanel = d3.select("#details");

// Selection handling
let selectedNode = null;
let selectedEdge = null;

function selectNode(d) {
  if (selectedNode) {
    d3.selectAll(".node").classed("selected", false);
  }
  selectedNode = d;
  d3.select(this).classed("selected", true);
  
  showNodeDetails(d);
}

function showNodeDetails(d) {
  const aliases = d.aliases && d.aliases.length > 0 ? d.aliases : [];
  const evidence = d.evidence && d.evidence.length > 0 ? d.evidence : [];
  
  let html = `
    <div class="concept-card">
      <div class="concept-header">
        <span class="concept-tier tier-${d.tier}">${d.tier}</span>
        <h2 class="concept-title">${d.label}</h2>
      </div>
      
      <div class="concept-definition">${d.definition || '定義なし'}</div>
  `;
  
  if (aliases.length > 0) {
    html += `
      <div class="aliases-section">
        <div class="section-title">別名・関連用語</div>
        <div class="aliases">
          ${aliases.map(alias => `<span class="alias-tag">${alias}</span>`).join('')}
        </div>
      </div>
    `;
  }
  
  if (evidence.length > 0) {
    html += `
      <div class="evidence-section">
        <div class="section-title">根拠・引用</div>
        ${evidence.map(e => `<div class="evidence-item">${e.text}</div>`).join('')}
      </div>
    `;
  }
  
  html += `</div>`;
  
  detailPanel.html(html);
}

// Node interactions
node.on("click", selectNode)
  .on("mouseover", (event, d) => {
    if (selectedNode !== d) {
      tooltip.style("display", "block")
        .html(`<strong>${d.label}</strong><br/>${d.definition || ''}<br/><em>${d.tier}</em>`);
    }
  })
  .on("mousemove", (event, d) => {
    tooltip.style("left", (event.pageX + 10) + "px")
      .style("top", (event.pageY + 10) + "px");
  })
  .on("mouseout", () => tooltip.style("display", "none"));

// Simulation
const simulation = d3.forceSimulation(data.nodes)
  .force("link", d3.forceLink(links).id(d => d.id).distance(100).strength(0.5))
  .force("charge", d3.forceManyBody().strength(-300))
  .force("center", d3.forceCenter(width / 2, height / 2))
  .force("collision", d3.forceCollide().radius(30));

simulation.on("tick", () => {
  link.attr("x1", d => d.source.x).attr("y1", d => d.source.y)
      .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
      
  edgeLabel.attr("x", d => (d.source.x + d.target.x) / 2)
           .attr("y", d => (d.source.y + d.target.y) / 2 - 5);
           
  node.attr("transform", d => `translate(${d.x},${d.y})`);
});

// Drag behavior
node.call(d3.drag()
  .on("start", (event, d) => {
    if (!event.active) simulation.alphaTarget(0.3).restart();
    d.fx = d.x;
    d.fy = d.y;
  })
  .on("drag", (event, d) => {
    d.fx = event.x;
    d.fy = event.y;
  })
  .on("end", (event, d) => {
    if (!event.active) simulation.alphaTarget(0);
    d.fx = null;
    d.fy = null;
  }));

// Zoom behavior
const zoom = d3.zoom()
  .scaleExtent([0.3, 3])
  .on("zoom", (event) => g.attr("transform", event.transform));

svg.call(zoom);

// Zoom controls
d3.select("#zoom-in").on("click", () => {
  svg.transition().call(zoom.scaleBy, 1.5);
});

d3.select("#zoom-out").on("click", () => {
  svg.transition().call(zoom.scaleBy, 0.67);
});

d3.select("#zoom-reset").on("click", () => {
  svg.transition().call(zoom.transform, d3.zoomIdentity);
});

// Filter functionality
function applyFilters() {
  const showCore = document.getElementById("showCore").checked;
  const showSupp = document.getElementById("showSupplementary").checked;
  const showAdv = document.getElementById("showAdvanced").checked;
  
  node.style("display", d => {
    return (d.tier === "core" && showCore) || 
           (d.tier === "supplementary" && showSupp) || 
           (d.tier === "advanced" && showAdv) ? null : "none";
  });
  
  const visible = new Set();
  node.filter(function() { 
    return d3.select(this).style("display") !== "none"; 
  }).each(d => visible.add(d.id));
  
  link.style("display", e => {
    return (visible.has(e.source.id) && visible.has(e.target.id)) ? null : "none";
  });
  
  edgeLabel.style("display", e => {
    return (visible.has(e.source.id) && visible.has(e.target.id)) ? null : "none";
  });
}

// Event listeners
document.getElementById("showCore").addEventListener("change", applyFilters);
document.getElementById("showSupplementary").addEventListener("change", applyFilters);
document.getElementById("showAdvanced").addEventListener("change", applyFilters);

// Initialize
applyFilters();

// Auto-select first core concept
const firstCore = data.nodes.find(d => d.tier === "core");
if (firstCore) {
  setTimeout(() => {
    const firstCoreNode = node.filter(d => d === firstCore);
    if (!firstCoreNode.empty()) {
      selectNode.call(firstCoreNode.node(), firstCore);
    }
  }, 100);
}
</script>
</body>
</html>